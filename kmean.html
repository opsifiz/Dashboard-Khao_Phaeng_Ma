<!doctype html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <title>Project #3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        html, body { height: 100%; margin: 0; }
        #map { height: 90%; }
        #controls { height: 10%; padding: 5px; background: #f7f7f7; display: flex; align-items: center; gap: 10px; }
        .floating-rect {
            position: fixed;
            bottom: 20px;
            width: 200px;
            background-color: rgba(135, 135, 135, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .floating-rect.minimized {
            height: 30px;
            padding: 10px;
        }

        .modal1{
        height: 160px;
        }

        .modal2{
        height: 300px;
        }

        .close-btn {
            cursor: pointer;
            font-size: 12px;
            background-color: #f00;
            border: 1px solid #888;
            border-radius: 3px;
            padding: 2px 5px;
            float: right;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label for="animalSelect">เลือกสัตว์:</label>
        <select id="animalSelect">
            <option value="all">ทั้งหมด</option>
        </select>
        <label for="yearSelect">เลือกฤดู:</label>
        <select id="seasonSelect">
            <option value="all">ทั้งหมด</option>
            <option value="summer">ฤดูร้อน</option>
            <option value="rainy">ฤดูฝน</option>
            <option value="winter">ฤดูหนาว</option>
        </select>
        <label for="mapSelect">ประเภทแผนที่:</label>
        <select id="mapSelect"></select>
        <label for="clustering">จัดกลุ่ม:</label>
        <button id="runBtn">ทำงาน</button>
    </div>
    <div id="map"></div>
    <div class="floating-rect modal1" id="rect1" style="top: 20px; right: 20px;">
        <span id="toggle-btn1" class="close-btn">–</span>
        <b>ข้อมูลสัตว์</b>
        <br>
        <hr style="width: 90%;">
        <div id="data">
            <img src="assets/ช้างป่า_000000.png" style="height: 15px;" alt=""> ช้างป่า<br>
            <!-- <img src="assets/ลิงกัง_000000.png" style="height: 15px;" alt=""> ลิงกัง<br> -->
            <img src="assets/กระทิง_000000.png" style="height: 15px;" alt=""> กระทิง<br>
            <!-- <img src="assets/เลียงผา_000000.png" style="height: 15px;" alt=""> เลียงผา<br>
            <img src="assets/กวาง_000000.png" style="height: 15px;" alt=""> กวาง<br>
            <img src="assets/หมีควาย_000000.png" style="height: 15px;" alt=""> หมีควาย<br> -->
        </div>
    </div>

    <div class="floating-rect modal2" id="rect2" style="left: 20px;">
        <span id="toggle-btn2" class="close-btn">–</span>
        <b>ข้อมูลเพิ่มเติม</b>
        <br>
        <hr style="width: 90%;">
        <div id="moreInfo">
            <span style="color:#800000">■</span> มกราคม<br>
            <span style="color:#FF0000">■</span> กุมภาพันธ์<br>
            <span style="color:#FF7F00">■</span> มีนาคม<br>
            <span style="color:#FFC0CB">■</span> เมษายน<br>
            <span style="color:#FFFF00">■</span> พฤษภาคม<br>
            <span style="color:#00FF00">■</span> มิถุนายน<br>
            <span style="color:#0000FF">■</span> กรกฎาคม<br>
            <span style="color:#8B00FF">■</span> สิงหาคม<br>
            <span style="color:#4B0082">■</span> กันยายน<br>
            <span style="color:#A9A9A9">■</span> ตุลาคม<br>
            <span style="color:#4c4c4c">■</span> พฤศจิกายน<br>
            <span style="color:#000000">■</span> ธันวาคม<br>
        </div>
    </div>

    <script src="clustering.js"></script>
    <script>
    function runClustering(coordinates) {

        const k = findBestK(coordinates);
        const result = kmeans(coordinates, k, 20);
        // console.log("k =", k);
        // console.log("labels =", result.labels);
        // console.log("centroids =", result.centroids);
        return {k, labels: result.labels, centroids: result.centroids};
    }
    </script>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.19.10/proj4.js"></script>
    <script src="scripts/selector/mapSelector.js"></script>
    <script>
        const rect1 = document.getElementById("rect1");
        const toggleBtn1 = document.getElementById("toggle-btn1");
        const dataInfo = document.getElementById('data');
        
        toggleBtn1.addEventListener("click", () => {
            rect1.classList.toggle("minimized");
            toggleBtn1.textContent = rect1.classList.contains("minimized") ? "+" : "–";
            dataInfo.style.display = (dataInfo.style.display === 'none') ? 'block' : 'none';
        });
        
        const rect2 = document.getElementById("rect2");
        const toggleBtn2 = document.getElementById("toggle-btn2");
        const info = document.getElementById('moreInfo');

        toggleBtn2.addEventListener("click", () => {
            rect2.classList.toggle("minimized");
            toggleBtn2.textContent = rect2.classList.contains("minimized") ? "+" : "–";
            info.style.display = (info.style.display === 'none') ? 'block' : 'none';
        });

        const name2hex = {
            "ช้างป่า":  "#FF0000",
            "กระทิง":  "#0000FF",
            "ลิงกัง":   "#00FF00",
            "เลียงผา": "#FF7F00",
            "กวาง":   "#4B0082",
            "หมีควาย": "#8B00FF",
            "1":  "#800000",
            "2":  "#FF0000",
            "3":  "#FF7F00",
            "4":  "#FFC0CB",
            "5":  "#FFFF00",
            "6":  "#00FF00",
            "7":  "#0000FF",
            "8":  "#8B00FF",
            "9":  "#4B0082",
            "10": "#A9A9A9",
            "11": "#4c4c4c",
            "12": "#000000"
        }

        const month2season = [
            "-",
            "winter",
            "winter",
            "summer",
            "summer",
            "summer",
            "summer",
            "rainy",
            "rainy",
            "rainy",
            "rainy",
            "winter",
            "winter",
        ];

        const color2hex = {
            "red" : "#FF0000",
            "green" : "0000FF",
            "blue" : "00FF00",
        };

        const KHAO_PHAENG_MA = [14.375, 101.79];

        const map = L.map('map').setView(KHAO_PHAENG_MA, 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        L.marker(KHAO_PHAENG_MA, { icon: redIcon })
        .addTo(map)
        .bindPopup("<b>เขาแผงม้า</b>")
        .openPopup();

        let animalLayers = [];
        let animals = new Set();

        fetch("./data/border_data.json")
        .then(response => response.json())
        .then(borderData => {

            const zoneNumber = 47;
            const hemisphere = 'N';
            const utmProj = `+proj=utm +zone=${zoneNumber} +datum=WGS84 ${hemisphere === 'S' ? '+south' : ''}`;

            const latlngs = borderData.map(pt => {
                let x = parseFloat(pt.x);
                let y = parseFloat(pt.y);
                const [lon, lat] = proj4(utmProj, 'WGS84', [x, y]);
                return [lat, lon];
            });

            if (latlngs.length > 0) {
                latlngs.push(latlngs[0]);
            }

            const borderPolygon = L.polygon(latlngs, {
                color: "#FF0000",
                weight: 2,
                fillOpacity: 0.1
            }).addTo(map);

            map.fitBounds(borderPolygon.getBounds());
        });

        fetch("./data/animals_data.json")
        .then(response => response.json())
        .then(res => {
            const zoneNumber = 47;
            const hemisphere = 'N';
            const utmProj = `+proj=utm +zone=${zoneNumber} +datum=WGS84 ${hemisphere === 'S' ? '+south' : ''}`;
            let ind = 0;
            res.forEach(row => {
                if(row.X == '-' || row.Y == '-' || row.Type == '-') return;
                if(row.Type == "ลูกกระทิง") row.Type = "กระทิง";
                let year = parseInt(row["วัน/เดือน/ปี"].split('-')[0]);
                if(year <= 2025) year += 543;
                let month = parseInt(row["วัน/เดือน/ปี"].split('-')[1]);
                let x = parseInt(row.X);
                let y = parseInt(row.Y);
                const [lon, lat] = proj4(utmProj, 'WGS84', [x, y]);

                animals.add(row.Type);

                let shape = L.circleMarker([lat, lon], {
                    color: name2hex[month],
                    fillColor: name2hex[month],
                    fillOpacity: 0.3,
                    radius: 5
                }).bindPopup(`<b>${row.Type}</b><br>จำนวน: ${row.Quantity}`);

                const curIcon = L.icon({
                    iconUrl: `assets/${row.Type}_${name2hex[month].slice(1)}.png`,
                    iconSize: [10, 10],
                    iconAnchor: [10, 10],
                    popupAnchor: [10, 10]
                });

                shape = L.marker([lat, lon], {icon: curIcon}
                ).bindPopup(`<b>${row.Type}</b><br>จำนวน: ${row.Quantity}`);

                animalLayers.push({type: row.Type, layer: shape, month: month, year: year, lat: lat, lon: lon});
                shape.addTo(map);
            });

            const selectAnimals = document.getElementById("animalSelect");
            const selectSeasons = document.getElementById("seasonSelect");

            Array.from(animals).forEach(a => {
                const opt = document.createElement("option");
                opt.value = a;
                opt.textContent = a;
                selectAnimals.appendChild(opt);
            });

            let curAnimal = "all";
            let curSeason = "all";

            selectAnimals.addEventListener("change", () => {
                curAnimal = selectAnimals.value;
                // console.log(value);
                animalLayers.forEach(obj => {
                    if((curAnimal === 'all' || obj.type == curAnimal) && (curSeason === 'all' || month2season[obj.month] == curSeason)){
                        if(!map.hasLayer(obj.layer)) obj.layer.addTo(map);
                    } else {
                        if(map.hasLayer(obj.layer)) map.removeLayer(obj.layer);
                    }
                });
            });
            
            selectSeasons.addEventListener("change", () => {
                curSeason = selectSeasons.value;
                // console.log(value);
                animalLayers.forEach(obj => {
                    if((curAnimal === 'all' || obj.type == curAnimal) && (curSeason === 'all' || month2season[obj.month] == curSeason)){
                        if(!map.hasLayer(obj.layer)) obj.layer.addTo(map);
                    } else {
                        if(map.hasLayer(obj.layer)) map.removeLayer(obj.layer);
                    }
                });
            });

            function filtering(res, curAnimal, curSeason){
                res = res.filter(row => row.Type === curAnimal && month2season[row.month] === curSeason);
                return res;
            }
    
            document.getElementById("runBtn").addEventListener("click", async ()=>{
                if(curAnimal !== "ช้างป่า" && curAnimal !== "กระทิง"){
                    console.error("Unavailable Animal!");
                    return;
                }else if(curSeason === "all"){
                    console.error("Please Select Season!");
                    return;
                }
    
                let points = [];
                let mappingIndex = [];
                
                animalLayers.forEach((obj, idx) => {
                    if((curAnimal === 'all' || obj.type == curAnimal) && (curSeason === 'all' || month2season[obj.month] == curSeason)){
                        if(!map.hasLayer(obj.layer)) obj.layer.addTo(map);
                        points.push([obj.lon, obj.lat]);
                        mappingIndex.push(idx);
                    } else {
                        if(map.hasLayer(obj.layer)) map.removeLayer(obj.layer);
                    }
                });

                const clusteringResult = runClustering(points);
                
                console.log(clusteringResult);

                clusteringResult.labels.forEach((label, i) => {
                    const objIndex = mappingIndex[i];
                    const obj = animalLayers[objIndex];

                    if (obj.layer instanceof L.Marker) { //MUST BE TRUE
                        const newIcon = L.icon({
                            iconUrl: `assets/${obj.type}_${name2hex[String(label+1)].slice(1)}.png`,
                            iconSize: [10, 10]
                        });
                        obj.layer.setIcon(newIcon);
                    }
                });
                
            });
        });


    </script>
</body>
</html>
