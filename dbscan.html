<!doctype html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <title>Project #3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        html, body { height: 100%; margin: 0; }
        #map { height: 90%; }
        #controls { height: 10%; padding: 5px; background: #f7f7f7; display: flex; align-items: center; gap: 10px; }
        .floating-rect {
            position: fixed;
            bottom: 20px;
            width: 200px;
            background-color: rgba(135, 135, 135, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .floating-rect.minimized {
            height: 30px;
            padding: 10px;
        }

        .modal1{
            height: 160px;
        }

        .modal2{
            height: 300px;
        }

        .close-btn {
            cursor: pointer;
            font-size: 12px;
            background-color: #f00;
            border: 1px solid #888;
            border-radius: 3px;
            padding: 2px 5px;
            float: right;
        }
    </style>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="controls">
        <div class="animalSelect">
            <label for="animalSelect">เลือกสัตว์:</label>
            <select id="animalSelect">
                <option value="all">ทั้งหมด</option>
            </select>
        </div>

        <div class="classifySelect">
            <label for="classify">จำแนก</label>
            <select id="classify"></select>
        </div>
        
        <div class="monthSelect">
            <label for="monthSelect">เลือกเดือน:</label>
            <select id="monthSelect"></select>
        </div>
        
        <div class="seasonSelect">
            <label for="seasonSelect">เลือกฤดู:</label>
            <select id="seasonSelect"></select>
        </div>
        
        <div class="mapSelect">
            <label for="mapSelect">ประเภทแผนที่:</label>
            <select id="mapSelect"></select>
        </div>

        <div class="clustering">
            <label for="clustering">จัดกลุ่ม:</label>
            <button id="runBtn">ทำงาน</button>
        </div>

        <div class="borderModal">
            <button id="borderLineModalBtn">
                <label for="borderLineModal">ตั้งค่าเส้นเขตแดน</label>
            </button>
        </div>
    </div>
    <div id="map"></div>
    <div class="floating-rect modal1" id="rect1" style="top: 20px; right: 20px;">
        <span id="toggle-btn1" class="close-btn">–</span>
        <b>ข้อมูลสัตว์</b>
        <br>
        <hr style="width: 90%;">
        <div id="data">
            <img src="assets/ช้างป่า_000000.png" style="height: 15px;" alt=""> ช้างป่า<br>
            <!-- <img src="assets/ลิงกัง_000000.png" style="height: 15px;" alt=""> ลิงกัง<br> -->
            <img src="assets/กระทิง_000000.png" style="height: 15px;" alt=""> กระทิง<br>
            <!-- <img src="assets/เลียงผา_000000.png" style="height: 15px;" alt=""> เลียงผา<br>
            <img src="assets/กวาง_000000.png" style="height: 15px;" alt=""> กวาง<br>
            <img src="assets/หมีควาย_000000.png" style="height: 15px;" alt=""> หมีควาย<br> -->
        </div>
    </div>

    <div class="floating-rect modal2" id="rect2" style="left: 20px;">
        <span id="toggle-btn2" class="close-btn">–</span>
        <b>ข้อมูลเพิ่มเติม</b>
        <br>
        <hr style="width: 90%;">
        <div id="moreInfo">
            <span style="color:#800000">■</span> มกราคม<br>
            <span style="color:#FF0000">■</span> กุมภาพันธ์<br>
            <span style="color:#FF7F00">■</span> มีนาคม<br>
            <span style="color:#FFC0CB">■</span> เมษายน<br>
            <span style="color:#FFFF00">■</span> พฤษภาคม<br>
            <span style="color:#00FF00">■</span> มิถุนายน<br>
            <span style="color:#0000FF">■</span> กรกฎาคม<br>
            <span style="color:#8B00FF">■</span> สิงหาคม<br>
            <span style="color:#4B0082">■</span> กันยายน<br>
            <span style="color:#A9A9A9">■</span> ตุลาคม<br>
            <span style="color:#4c4c4c">■</span> พฤศจิกายน<br>
            <span style="color:#000000">■</span> ธันวาคม<br>
        </div>
    </div>
    <div id="borderLineModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close" id="close-tutorial">&times;</span>
            <p class="modal-title">ตั้งค่าเส้นเขตแดน</p>
            <hr>
            <p class="modal-sub-title">จังหวัด</p>
            <div class="multi-select center" id="multiSelectProvince">
                <div class="selected" id="selectedProvinceItems">
                    <span class="placeholder">Select Provinces</span>
                </div>
                <div id="provinceDropdown" class="dropdown hidden">
                    <input type="text" id="searchProvince" class="search" placeholder="Search...">
                    <div class="action-bar">
                        <button class="btn-select-all">All</button>
                        <button class="btn-clear-all">Clear</button>
                    </div>
                    <ul id="provinceOptionList" class="options"></ul>
                </div>
            </div>
            <p class="modal-sub-title">อำเภอ</p>
            <div class="multi-select center" id="multiSelectAmphoe">
                <div class="selected" id="selectedAmphoeItems">
                    <span class="placeholder">Select Amphoes</span>
                </div>
                <div id="amphoeDropdown" class="dropdown hidden">
                    <input type="text" id="searchAmphoe" class="search" placeholder="Search...">
                    <div class="action-bar">
                        <button class="btn-select-all">All</button>
                        <button class="btn-clear-all">Clear</button>
                    </div>
                    <ul id="amphoeOptionList" class="options"></ul>
                </div>
            </div>
            <p class="modal-sub-title">ตำบล</p>
            <div class="multi-select center" id="multiSelectTambon">
                <div class="selected" id="selectedTambonItems">
                    <span class="placeholder">Select Tambons</span>
                </div>
                <div id="tambonDropdown" class="dropdown hidden">
                    <input type="text" id="searchTambon" class="search" placeholder="Search...">
                    <div class="action-bar">
                        <button class="btn-select-all">All</button>
                        <button class="btn-clear-all">Clear</button>
                    </div>
                    <ul id="tambonOptionList" class="options"></ul>
                </div>
            </div>
            <p class="modal-sub-title">แนวเขตป่าอนุรักษ์</p>
            <div class="multi-select center" id="multiSelectArea">
                <div class="selected" id="selectedAreaItems">
                    <span class="placeholder">Select Areas</span>
                </div>
                <div id="areaDropdown" class="dropdown hidden">
                    <input type="text" id="searchArea" class="search" placeholder="Search...">
                    <div class="action-bar">
                        <button class="btn-select-all">All</button>
                        <button class="btn-clear-all">Clear</button>
                    </div>
                    <ul id="areaOptionList" class="options"></ul>
                </div>
            </div>
            <hr style="width: 80%;">
            <p class="mapOptions">Show Border</p>
            <input type="checkbox" id="showBorder">
            <span>show</span>
            <p class="mapOptions">Border Color</p>
            <input disabled type="color" value="#ff0000" id="borderColor">
            <br>
        </div>
    </div>
    <script type="module">
        import { loadData } from "./scripts/loadData.js";

        let provincesSelected = new Set();
        let amphoesSelected = new Set();
        let tambonsSelected = new Set();
        let areasSelected = new Set();

        let provinceBorderLayers = {};
        let amphoeBorderLayers = {};
        let tambonBorderLayers = {};
        let areaBorderLayers = {};

        const provinces = await loadData("provinces");
        const amphoes = await loadData("amphoes");
        const tambons = await loadData("tambons");
        const areas = await loadData("areas");

        const multiSelectProvinces = document.getElementById("multiSelectProvince");
        const multiSelectAmphoes = document.getElementById("multiSelectAmphoe");
        const multiSelectTambons = document.getElementById("multiSelectTambon");
        const multiSelectAreas = document.getElementById("multiSelectArea");

        const showBorderBtn = document.getElementById("showBorder");
        const borderColorValue = document.getElementById("borderColor");

        const selectAllProvincesBtn = multiSelectProvinces.querySelector(".btn-select-all");
        const clearAllProvincesBtn = multiSelectProvinces.querySelector(".btn-clear-all");

        const selectAllAmphoesBtn = multiSelectAmphoes.querySelector(".btn-select-all");
        const clearAllAmphoesBtn = multiSelectAmphoes.querySelector(".btn-clear-all");

        const selectAllTambonBtn = multiSelectTambons.querySelector(".btn-select-all");
        const clearAllTambonBtn = multiSelectTambons.querySelector(".btn-clear-all");

        const selectAllAreaBtn = multiSelectAreas.querySelector(".btn-select-all");
        const clearAllAreaBtn = multiSelectAreas.querySelector(".btn-clear-all");

        selectAllProvincesBtn.onclick = () => {
            provinces.forEach(item => provincesSelected.add(item.value));
            renderSelectedProvince();
            renderProvinceOptions(searchProvinceInput.value);
            renderBorders();
        };
        
        clearAllProvincesBtn.onclick = () => {
            provincesSelected.clear();
            renderSelectedProvince();
            renderProvinceOptions(searchProvinceInput.value);
            renderBorders();
        };

        selectAllAmphoesBtn.onclick = () => {
            amphoes.forEach(item => amphoesSelected.add(item.value));
            renderSelectedAmphoe();
            renderAmphoeOptions(searchAmphoeInput.value);
            renderBorders();
        };
        
        clearAllAmphoesBtn.onclick = () => {
            amphoesSelected.clear();
            renderSelectedAmphoe();
            renderAmphoeOptions(searchAmphoeInput.value);
            renderBorders();
        };

        selectAllTambonBtn.onclick = () => {
            tambons.forEach(item => tambonsSelected.add(item.value));
            renderSelectedTambon();
            renderTambonOptions(searchTambonInput.value);
            renderBorders();
        };
        
        clearAllTambonBtn.onclick = () => {
            tambonsSelected.clear();
            renderSelectedTambon();
            renderTambonOptions(searchTambonInput.value);
            renderBorders();
        };

        selectAllAreaBtn.onclick = () => {
            areas.forEach(item => areasSelected.add(item.value));
            renderSelectedArea();
            renderAreaOptions(searchAreaInput.value);
            renderBorders();
        };
        
        clearAllAreaBtn.onclick = () => {
            areasSelected.clear();
            renderSelectedArea();
            renderAreaOptions(searchAreaInput.value);
            renderBorders();
        };

        showBorderBtn.addEventListener("change", renderBorders);
        borderColorValue.addEventListener("input", renderBorders);

        showBorderBtn.addEventListener("change", ()=>{
            const value = showBorderBtn.checked;
            borderColorValue.disabled = !value;
        });

        const selectedProvinceBox = document.getElementById("selectedProvinceItems");
        const selectedAmphoeBox = document.getElementById("selectedAmphoeItems");
        const selectedTambonBox = document.getElementById("selectedTambonItems");
        const selectedAreaBox = document.getElementById("selectedAreaItems");

        const dropdownProvince = document.getElementById("provinceDropdown");
        const dropdownAmphoe = document.getElementById("amphoeDropdown");
        const dropdownTambon = document.getElementById("tambonDropdown");
        const dropdownArea = document.getElementById("areaDropdown");

        const searchProvinceInput = document.getElementById("searchProvince");
        const searchAmphoeInput = document.getElementById("searchAmphoe");
        const searchTambonInput = document.getElementById("searchTambon");
        const searchAreaInput = document.getElementById("searchArea");

        const provinceOptionList = document.getElementById("provinceOptionList");
        const amphoeOptionList = document.getElementById("amphoeOptionList");
        const tambonOptionList = document.getElementById("tambonOptionList");
        const areaOptionList = document.getElementById("areaOptionList");

        async function renderBorders(){
            Object.values(provinceBorderLayers).forEach(layer => {
                if(map.hasLayer(layer)) map.removeLayer(layer);
            });
            Object.values(amphoeBorderLayers).forEach(layer => {
                if(map.hasLayer(layer)) map.removeLayer(layer);
            });
            Object.values(tambonBorderLayers).forEach(layer => {
                if(map.hasLayer(layer)) map.removeLayer(layer);
            });
            Object.values(areaBorderLayers).forEach(layer => {
                if(map.hasLayer(layer)) map.removeLayer(layer);
            });

            provinceBorderLayers = {};
            amphoeBorderLayers = {};
            tambonBorderLayers = {};
            areaBorderLayers = {};

            if(!showBorderBtn.checked) return;

            for(const value of provincesSelected){
                try{
                    const res = await fetch(`./border/province/${value}.geojson`);
                    if(!res.ok){
                        console.error(`Failed to fetch ./border/province/${value}.geojson`);
                        continue;
                    }

                    const geojson = await res.json();

                    const layer = L.geoJSON(geojson, {
                        style: {
                            color: borderColorValue.value,
                            weight: 2,
                            fillOpacity: 0
                        }
                    }).addTo(map);

                    provinceBorderLayers[value] = layer;
                }catch(err){
                    console.error(err);
                }
            }

            for(const value of amphoesSelected){
                try{
                    const res = await fetch(`./border/amphoe/${value}.geojson`);
                    if(!res.ok){
                        console.error(`Failed to fetch ./border/amphoe/${value}.geojson`);
                        continue;
                    }

                    const geojson = await res.json();

                    const layer = L.geoJSON(geojson, {
                        style: {
                            color: borderColorValue.value,
                            weight: 2,
                            fillOpacity: 0
                        }
                    }).addTo(map);

                    amphoeBorderLayers[value] = layer;
                }catch(err){
                    console.error(err);
                }
            }

            for(const value of tambonsSelected){
                try{
                    const res = await fetch(`./border/tambon/${value}.geojson`);
                    if(!res.ok){
                        console.error(`Failed to fetch ./border/tambon/${value}.geojson`);
                        continue;
                    }

                    const geojson = await res.json();

                    const layer = L.geoJSON(geojson, {
                        style: {
                            color: borderColorValue.value,
                            weight: 2,
                            fillOpacity: 0
                        }
                    }).addTo(map);

                    tambonBorderLayers[value] = layer;
                }catch(err){
                    console.error(err);
                }
            }
            for(const value of areasSelected){
                try{
                    const res = await fetch(`./border/area/${value}.geojson`);
                    if(!res.ok){
                        console.error(`Failed to fetch ./border/area/${value}.geojson`);
                        continue;
                    }

                    const geojson = await res.json();

                    const layer = L.geoJSON(geojson, {
                        style: {
                            color: borderColorValue.value,
                            weight: 2,
                            fillOpacity: 0
                        }
                    }).addTo(map);

                    areaBorderLayers[value] = layer;
                }catch(err){
                    console.error(err);
                }
            }
        }

        function renderProvinceOptions(filter = "") {
            provinceOptionList.innerHTML = "";
            provinces
            .filter(item => item.label.toLowerCase().includes(filter.toLowerCase()))
            .forEach(item => {
                const label = item.label;
                const value = item.value;

                const li = document.createElement("li");
                li.textContent = label;
                li.dataset.value = value;

                if (provincesSelected.has(value)) {
                    li.style.fontWeight = "bold";
                }

                li.onclick = () => {
                    provincesSelected.has(value) ? provincesSelected.delete(value) : provincesSelected.add(value);
                    renderSelectedProvince();
                    renderProvinceOptions(searchProvinceInput.value);
                    renderBorders();
                };

                provinceOptionList.appendChild(li);
            });
        }

        function renderAmphoeOptions(filter = "") {
            amphoeOptionList.innerHTML = "";
            amphoes
            .filter(item => item.label.toLowerCase().includes(filter.toLowerCase()))
            .forEach(item => {
                const label = item.label;
                const value = item.value;
                
                const li = document.createElement("li");
                li.textContent = label;
                li.dataset.value = value;

                if (amphoesSelected.has(value)) {
                    li.style.fontWeight = "bold";
                }

                li.onclick = () => {
                    amphoesSelected.has(value) ? amphoesSelected.delete(value) : amphoesSelected.add(value);
                    renderSelectedAmphoe();
                    renderAmphoeOptions(searchAmphoeInput.value);
                    renderBorders();
                };

                amphoeOptionList.appendChild(li);
            });
        }

        function renderTambonOptions(filter = "") {
            tambonOptionList.innerHTML = "";
            tambons
            .filter(item => item.label.toLowerCase().includes(filter.toLowerCase()))
            .forEach(item => {
                const label = item.label;
                const value = item.value;
                
                const li = document.createElement("li");
                li.textContent = label;
                li.dataset.value = value;

                if (tambonsSelected.has(value)) {
                    li.style.fontWeight = "bold";
                }

                li.onclick = () => {
                    tambonsSelected.has(value) ? tambonsSelected.delete(value) : tambonsSelected.add(value);
                    renderSelectedTambon();
                    renderTambonOptions(searchTambonInput.value);
                    renderBorders();
                };

                tambonOptionList.appendChild(li);
            });
        }

        function renderAreaOptions(filter = "") {
            areaOptionList.innerHTML = "";
            areas
            .filter(item => item.label.toLowerCase().includes(filter.toLowerCase()))
            .forEach(item => {
                const label = item.label;
                const value = item.value;
                
                const li = document.createElement("li");
                li.textContent = label;
                li.dataset.value = value;

                if (areasSelected.has(value)) {
                    li.style.fontWeight = "bold";
                }

                li.onclick = () => {
                    areasSelected.has(value) ? areasSelected.delete(value) : areasSelected.add(value);
                    renderSelectedArea();
                    renderAreaOptions(searchAreaInput.value);
                    renderBorders();
                };

                areaOptionList.appendChild(li);
            });
        }
        
        function renderSelectedProvince() {
            selectedProvinceBox.innerHTML = "";
            if (provincesSelected.size === 0) {
                selectedProvinceBox.innerHTML = `<span class="placeholder">Select Provinces</span>`;
                return;
            }
            provincesSelected.forEach(value => {
                const label = provinces.find(d => d.value === value).label;
                
                const tag = document.createElement("span");
                tag.className = "tag";
                tag.dataset.value = value;
                
                const text = document.createElement("span");
                text.innerText = label;
                
                const removeBtn = document.createElement("span");
                removeBtn.innerText = "X";
                removeBtn.style.cursor = "pointer";
                removeBtn.style.marginLeft = "4px";
                removeBtn.style.color = "red";
                
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    const v = tag.dataset.value;
                    provincesSelected.delete(v);
                    renderSelectedProvince();
                    renderProvinceOptions(searchProvinceInput.value);
                    renderBorders();
                };
                
                tag.appendChild(text);
                tag.appendChild(removeBtn);
                selectedProvinceBox.appendChild(tag);
            });
            console.log(provincesSelected);
        }
        
        function renderSelectedAmphoe() {
            selectedAmphoeBox.innerHTML = "";
            if (amphoesSelected.size === 0) {
                selectedAmphoeBox.innerHTML = `<span class="placeholder">Select Amphoes</span>`;
                return;
            }
            amphoesSelected.forEach(value => {
                const label = amphoes.find(d => d.value === value).label;
                
                const tag = document.createElement("span");
                tag.className = "tag";
                tag.dataset.value = value;
                
                const text = document.createElement("span");
                text.innerText = label;
                
                const removeBtn = document.createElement("span");
                removeBtn.innerText = "X";
                removeBtn.style.cursor = "pointer";
                removeBtn.style.marginLeft = "4px";
                removeBtn.style.color = "red";
                
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    const v = tag.dataset.value;
                    amphoesSelected.delete(v);
                    renderSelectedAmphoe();
                    renderAmphoeOptions(searchAmphoeInput.value);
                    renderBorders();
                };
                
                tag.appendChild(text);
                tag.appendChild(removeBtn);
                selectedAmphoeBox.appendChild(tag);
            });
            console.log(amphoesSelected);
        }
        
        function renderSelectedTambon() {
            selectedTambonBox.innerHTML = "";
            if (tambonsSelected.size === 0) {
                selectedTambonBox.innerHTML = `<span class="placeholder">Select Tambons</span>`;
                return;
            }
            tambonsSelected.forEach(value => {
                const label = tambons.find(d => d.value === value).label;
                
                const tag = document.createElement("span");
                tag.className = "tag";
                tag.dataset.value = value;
                
                const text = document.createElement("span");
                text.innerText = label;
                
                const removeBtn = document.createElement("span");
                removeBtn.innerText = "X";
                removeBtn.style.cursor = "pointer";
                removeBtn.style.marginLeft = "4px";
                removeBtn.style.color = "red";
                
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    const v = tag.dataset.value;
                    tambonsSelected.delete(v);
                    renderSelectedTambon();
                    renderTambonOptions(searchTambonInput.value);
                    renderBorders();
                };
                
                tag.appendChild(text);
                tag.appendChild(removeBtn);
                selectedTambonBox.appendChild(tag);
            });
            console.log(tambonsSelected);
        }
            
        function renderSelectedArea() {
            selectedAreaBox.innerHTML = "";
            if (areasSelected.size === 0) {
                selectedAreaBox.innerHTML = `<span class="placeholder">Select Areas</span>`;
                return;
            }
            areasSelected.forEach(value => {
                const label = areas.find(d => d.value === value).label;
            
                const tag = document.createElement("span");
                tag.className = "tag";
                tag.dataset.value = value;
            
                const text = document.createElement("span");
                text.innerText = label;
            
                const removeBtn = document.createElement("span");
                removeBtn.innerText = "X";
                removeBtn.style.cursor = "pointer";
                removeBtn.style.marginLeft = "4px";
                removeBtn.style.color = "red";
            
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    const v = tag.dataset.value;
                    areasSelected.delete(v);
                    renderSelectedArea();
                    renderAreaOptions(searchAreaInput.value);
                    renderBorders();
                };
            
                tag.appendChild(text);
                tag.appendChild(removeBtn);
                selectedAreaBox.appendChild(tag);
            });
            console.log(areasSelected);
        }

        selectedProvinceBox.onclick = () => {
            dropdownProvince.classList.toggle("hidden");
            searchProvinceInput.focus();
        };

        selectedAmphoeBox.onclick = () => {
            dropdownAmphoe.classList.toggle("hidden");
            searchAmphoeInput.focus();
        };
        
        selectedTambonBox.onclick = () => {
            dropdownTambon.classList.toggle("hidden");
            searchTambonInput.focus();
        };
        
        selectedAreaBox.onclick = () => {
            dropdownArea.classList.toggle("hidden");
            searchAreaInput.focus();
        };

        searchProvinceInput.oninput = (e) => {
            renderProvinceOptions(e.target.value);
        };

        searchAmphoeInput.oninput = (e) => {
            renderAmphoeOptions(e.target.value);
        };

        searchTambonInput.oninput = (e) => {
            renderTambonOptions(e.target.value);
        };

        searchAreaInput.oninput = (e) => {
            renderAreaOptions(e.target.value);
        };

        document.addEventListener("click", (e) => {
            if (!multiSelectProvince.contains(e.target)) {
                dropdownProvince.classList.add("hidden");
            }
            if (!multiSelectAmphoe.contains(e.target)) {
                dropdownAmphoe.classList.add("hidden");
            }
            if (!multiSelectTambon.contains(e.target)) {
                dropdownTambon.classList.add("hidden");
            }
            if (!multiSelectArea.contains(e.target)) {
                dropdownArea.classList.add("hidden");
            }
        });

        renderProvinceOptions();
        renderAmphoeOptions();
        renderTambonOptions();
        renderAreaOptions();
    </script>

    <script>
        var modal1 = document.getElementById("borderLineModal");
        var btn1 = document.getElementById("borderLineModalBtn");
        var span1 = document.getElementsByClassName("close")[0];
        btn1.onclick = function() {
            modal1.style.display = "block";
        }
        span1.onclick = function() {
            modal1.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal1) {
                modal1.style.display = "none";
            }
        }
    </script>

    <script src="clustering.js"></script>
    <script src="scripts/clustering/dbscan.js"></script>
    <script>
    function runClustering(coordinates) {
        const { labels, clusters } = dbscan(coordinates, 250, 3);

        return {
            k: clusters,
            labels,
            centroids: computeCentroids(coordinates, labels, clusters)
        };
    }
    </script>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.19.10/proj4.js"></script>
    <script src="scripts/selectors.js"></script>

    <script>
        const rect1 = document.getElementById("rect1");
        const toggleBtn1 = document.getElementById("toggle-btn1");
        const dataInfo = document.getElementById('data');
        
        toggleBtn1.addEventListener("click", () => {
            rect1.classList.toggle("minimized");
            toggleBtn1.textContent = rect1.classList.contains("minimized") ? "+" : "–";
            dataInfo.style.display = (dataInfo.style.display === 'none') ? 'block' : 'none';
        });
        
        const rect2 = document.getElementById("rect2");
        const toggleBtn2 = document.getElementById("toggle-btn2");
        const info = document.getElementById('moreInfo');

        toggleBtn2.addEventListener("click", () => {
            rect2.classList.toggle("minimized");
            toggleBtn2.textContent = rect2.classList.contains("minimized") ? "+" : "–";
            info.style.display = (info.style.display === 'none') ? 'block' : 'none';
        });
        
        const color2hex = {
            "red" : "#FF0000",
            "green" : "0000FF",
            "blue" : "00FF00",
        };

        const KHAO_PHAENG_MA = [14.375, 101.79];

        const map = L.map('map').setView(KHAO_PHAENG_MA, 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        L.marker(KHAO_PHAENG_MA, { icon: redIcon })
        .addTo(map)
        .bindPopup("<b>เขาแผงม้า</b>")
        .openPopup();

        let animalLayers = [];
        let animals = new Set();

        fetch("./data/animals_data.json")
        .then(response => response.json())
        .then(res => {
            const zoneNumber = 47;
            const hemisphere = 'N';
            const utmProj = `+proj=utm +zone=${zoneNumber} +datum=WGS84 ${hemisphere === 'S' ? '+south' : ''}`;
            let ind = 0;
            res.forEach(row => {
                if(row.X == '-' || row.Y == '-' || row.Type == '-') return;
                if(row.Type == "ลูกกระทิง") row.Type = "กระทิง";
                let year = parseInt(row["วัน/เดือน/ปี"].split('-')[0]);
                if(year <= 2025) year += 543;
                let month = parseInt(row["วัน/เดือน/ปี"].split('-')[1]);
                let x = parseInt(row.X);
                let y = parseInt(row.Y);
                const [lon, lat] = proj4(utmProj, 'WGS84', [x, y]);

                animals.add(row.Type);

                let shape = L.circleMarker([lat, lon], {
                    color: name2hex[month],
                    fillColor: name2hex[month],
                    fillOpacity: 0.3,
                    radius: 5
                }).bindPopup(`<b>${row.Type}</b><br>จำนวน: ${row.Quantity}`);

                const curIcon = L.icon({
                    iconUrl: `assets/${row.Type}_${name2hex[month].slice(1)}.png`,
                    iconSize: [10, 10],
                    iconAnchor: [10, 10],
                    popupAnchor: [10, 10]
                });

                shape = L.marker([lat, lon], {icon: curIcon}
                ).bindPopup(`<b>${row.Type}</b><br>จำนวน: ${row.Quantity}`);

                animalLayers.push({type: row.Type, layer: shape, month: month, year: year, lat: lat, lon: lon});
                shape.addTo(map);
            });

            const selectAnimal = document.getElementById("animalSelect");

            Array.from(animals).forEach(a => {
                const opt = document.createElement("option");
                opt.value = a;
                opt.textContent = a;
                selectAnimal.appendChild(opt);
            });

            selectAnimal.addEventListener("change", () => {
                curAnimal = selectAnimal.value;
                // console.log(value);
                animalLayers.forEach(obj => {
                    if((curAnimal === 'all' || obj.type == curAnimal) && (curSeason === 'all' || month2season[obj.month] == curSeason)){
                        if(!map.hasLayer(obj.layer)) obj.layer.addTo(map);
                    } else {
                        if(map.hasLayer(obj.layer)) map.removeLayer(obj.layer);
                    }
                });
            });
            
            function filtering(res, curAnimal, curSeason){
                res = res.filter(row => row.Type === curAnimal && month2season[row.month] === curSeason);
                return res;
            }
    
            document.getElementById("runBtn").addEventListener("click", async ()=>{
                if(curAnimal !== "ช้างป่า" && curAnimal !== "กระทิง"){
                    console.error("Unavailable Animal!");
                    return;
                }else if(curSeason === "all"){
                    console.error("Please Select Season!");
                    return;
                }
    
                let points = [];
                let mappingIndex = [];
                
                animalLayers.forEach((obj, idx) => {
                    if((curAnimal === 'all' || obj.type == curAnimal) && (curSeason === 'all' || month2season[obj.month] == curSeason)){
                        if(!map.hasLayer(obj.layer)) obj.layer.addTo(map);
                        points.push([obj.lon, obj.lat]);
                        mappingIndex.push(idx);
                    } else {
                        if(map.hasLayer(obj.layer)) map.removeLayer(obj.layer);
                    }
                });

                const clusteringResult = runClustering(points);
                
                console.log(clusteringResult);

                clusteringResult.labels.forEach((label, i) => {
                    if(label === -1){
                        hex = "#000000";
                    }else{
                        hex = name2hex[String(label+1)];
                    }
                    const objIndex = mappingIndex[i];
                    const obj = animalLayers[objIndex];

                    if (obj.layer instanceof L.Marker) { //MUST BE TRUE
                        const newIcon = L.icon({
                            iconUrl: `assets/${obj.type}_${hex.slice(1)}.png`,
                            iconSize: [10, 10]
                        });
                        obj.layer.setIcon(newIcon);
                    }
                });
            });
        });
    </script>
</body>
</html>
